name: MITE Watchdog

on:
  schedule:
    - cron: "*/5 * * * *"   # –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: mite-watchdog
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) –†—É—á–Ω–æ–π —Ç–µ—Å—Ç reboot ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ Run workflow
      - name: Test reboot webhook (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          REBOOT_WEBHOOK_URL: ${{ secrets.REBOOT_WEBHOOK_URL }}
          REBOOT_SECRET: ${{ secrets.REBOOT_SECRET }}
        run: |
          python3 - << 'PY'
          import os, urllib.request, urllib.parse
          base = os.environ["REBOOT_WEBHOOK_URL"]
          secret = os.environ["REBOOT_SECRET"]
          sep = "&" if "?" in base else "?"
          url = f"{base}{sep}key={urllib.parse.quote(secret)}"
          req = urllib.request.Request(url, method="POST")
          with urllib.request.urlopen(req, timeout=25) as r:
              body = r.read(2000).decode("utf-8","ignore")
              print("Webhook:", r.getcode(), body)
          PY

      - name: Ensure state file
        run: |
          if [ ! -f state.json ]; then
            echo '{"down_since": null, "last_alert_min": null, "rebooted": false}' > state.json
          fi

      - name: Monitor + Telegram + Reboot
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          REBOOT_WEBHOOK_URL: ${{ secrets.REBOOT_WEBHOOK_URL }}
          REBOOT_SECRET: ${{ secrets.REBOOT_SECRET }}
          MUST_CONTAIN: ${{ secrets.MUST_CONTAIN }}
        run: |
          python3 - << 'PY'
          import json, os, time
          import urllib.request, urllib.parse

          SITE_URL = os.environ["SITE_URL"]
          TG_TOKEN = os.environ["TG_TOKEN"]
          TG_CHAT_ID = os.environ["TG_CHAT_ID"]
          REBOOT_WEBHOOK_URL = os.environ["REBOOT_WEBHOOK_URL"]
          REBOOT_SECRET = os.environ["REBOOT_SECRET"]
          MUST_CONTAIN = os.environ.get("MUST_CONTAIN") or ""

          now = int(time.time())

          def http_check(url, timeout=20):
              try:
                  req = urllib.request.Request(url, method="GET", headers={"User-Agent":"mite-watchdog/1.0"})
                  with urllib.request.urlopen(req, timeout=timeout) as r:
                      code = r.getcode()
                      if not (200 <= code < 400):
                          return False
                      if MUST_CONTAIN:
                          body = r.read(250_000).decode("utf-8", errors="ignore")
                          return MUST_CONTAIN in body
                      return True
              except Exception:
                  return False

          def tg_send(text):
              api = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"
              data = urllib.parse.urlencode({"chat_id": TG_CHAT_ID, "text": text}).encode()
              try:
                  with urllib.request.urlopen(api, data=data, timeout=20) as r:
                      r.read()
              except Exception as e:
                  print("TG send failed:", e)

          def minutes_since(ts):
              return int((now - ts) / 60)

          def call_reboot_webhook():
              sep = "&" if "?" in REBOOT_WEBHOOK_URL else "?"
              url = f"{REBOOT_WEBHOOK_URL}{sep}key={urllib.parse.quote(REBOOT_SECRET)}"
              try:
                  req = urllib.request.Request(url, method="POST", headers={"User-Agent":"mite-watchdog/1.0"})
                  with urllib.request.urlopen(req, timeout=25) as r:
                      body = r.read(2000).decode("utf-8", "ignore")
                      print("Reboot webhook:", r.getcode(), body)
                      return 200 <= r.getcode() < 300
              except Exception as e:
                  print("Webhook failed:", e)
                  return False

          with open("state.json", "r", encoding="utf-8") as f:
              st = json.load(f)

          ok = http_check(SITE_URL)
          print("Checking:", SITE_URL, "OK?", ok)

          if ok:
              if st.get("down_since") is not None:
                  down_min = minutes_since(st["down_since"])
                  tg_send(f"‚úÖ UP: {SITE_URL} —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω. –ë—ã–ª DOWN ~{down_min} –º–∏–Ω.")
              st = {"down_since": None, "last_alert_min": None, "rebooted": False}
          else:
              if st.get("down_since") is None:
                  st["down_since"] = now
                  st["last_alert_min"] = 0
                  st["rebooted"] = False
                  tg_send(f"‚ùå DOWN: {SITE_URL} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. (0 –º–∏–Ω)")
              else:
                  down_min = minutes_since(st["down_since"])
                  last = st.get("last_alert_min")

                  if last is None or down_min >= last + 5:
                      st["last_alert_min"] = down_min
                      tg_send(f"‚ùå DOWN: {SITE_URL} –≤—Å—ë –µ—â—ë –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. (~{down_min} –º–∏–Ω)")

                  if (not st.get("rebooted")) and down_min >= 20:
                      if call_reboot_webhook():
                          st["rebooted"] = True
                          tg_send(f"üö® DOWN {down_min} –º–∏–Ω: –≤—ã–∑–≤–∞–Ω REBOOT webhook –¥–ª—è {SITE_URL}.")
                      else:
                          tg_send(f"‚ö†Ô∏è DOWN {down_min} –º–∏–Ω: –ù–ï —Å–º–æ–≥ –≤—ã–∑–≤–∞—Ç—å reboot webhook (–æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞).")

          with open("state.json", "w", encoding="utf-8") as f:
              json.dump(st, f, ensure_ascii=False, indent=2)

          print("STATE:", st)
          PY

      - name: Commit updated state
        run: |
          git config user.name "mite-watchdog"
          git config user.email "actions@users.noreply.github.com"
          git add state.json
          git commit -m "Update watchdog state" || echo "No changes"
          git push
