name: MITE Watchdog

on:
  schedule:
    - cron: "* * * * *"   # –ø—ã—Ç–∞–µ–º—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: mite-watchdog
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure state file
        run: |
          if [ ! -f state.json ]; then
            echo '{"down_since": null, "last_alert_ts": null, "rebooted": false, "last_check_ts": 0}' > state.json
          fi

      - name: Monitor + Telegram + Hetzner reboot after 20 min
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          HETZNER_TOKEN: ${{ secrets.HETZNER_TOKEN }}
          SERVER_ID: ${{ secrets.SERVER_ID }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python3 - << 'PY'
          import json, os, time
          import urllib.request, urllib.parse, urllib.error

          SITE_URL = os.environ["SITE_URL"]
          TG_TOKEN = os.environ["TG_TOKEN"]
          TG_CHAT_ID = os.environ["TG_CHAT_ID"]
          HETZNER_TOKEN = os.environ["HETZNER_TOKEN"]
          SERVER_ID = os.environ["SERVER_ID"]
          EVENT = os.environ.get("GITHUB_EVENT_NAME","")

          now = int(time.time())

          def tg_send(text: str):
              api = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"
              data = urllib.parse.urlencode({"chat_id": TG_CHAT_ID, "text": text}).encode()
              try:
                  urllib.request.urlopen(api, data=data, timeout=20).read()
              except Exception as e:
                  print("TG send failed:", e)

          def http_ok(url, timeout=15):
            try:
                req = urllib.request.Request(url, method="GET", headers={"User-Agent":"mite-watchdog/1.0"})
                with urllib.request.urlopen(req, timeout=timeout) as r:
                    code = r.getcode()
                    if not (200 <= code < 400):
                        return False, f"HTTP {code}"
                    return True, f"HTTP {code}"
            except urllib.error.HTTPError as e:
                return False, f"HTTPError {e.code}"
            except Exception as e:
                return False, f"Error {type(e).__name__}: {e}"


          def minutes_since(ts):
              return int((now - ts) / 60)

          def hetzner_reboot():
              url = f"https://api.hetzner.cloud/v1/servers/{SERVER_ID}/actions/reboot"
              req = urllib.request.Request(
                  url,
                  method="POST",
                  headers={
                      "Authorization": f"Bearer {HETZNER_TOKEN}",
                      "Content-Type": "application/json",
                      "User-Agent": "mite-watchdog/1.0",
                  },
              )
              try:
                  with urllib.request.urlopen(req, timeout=20) as r:
                      body = r.read(2000).decode("utf-8","ignore")
                      print("Hetzner reboot:", r.getcode(), body)
                      return 200 <= r.getcode() < 300
              except urllib.error.HTTPError as e:
                  body = e.read(2000).decode("utf-8","ignore")
                  print("Hetzner reboot HTTPError:", e.code, body)
                  return False
              except Exception as e:
                  print("Hetzner reboot error:", e)
                  return False

          # load state
          with open("state.json", "r", encoding="utf-8") as f:
              st = json.load(f)

          # throttle: —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç (–∫—Ä–æ–º–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
          last_check = int(st.get("last_check_ts") or 0)
          if EVENT != "workflow_dispatch" and (now - last_check) < 300:
              print("Skip check:", now - last_check, "sec since last check")
              raise SystemExit(0)
          st["last_check_ts"] = now

          ok, info = http_ok(SITE_URL)
          print("Checking:", SITE_URL, "=>", ok, info, "STATE:", st)

          if ok:
              if st.get("down_since") is not None:
                  down_min = minutes_since(st["down_since"])
                  tg_send(f"‚úÖ UP: {SITE_URL} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ë—ã–ª DOWN ~{down_min} –º–∏–Ω.")
              st["down_since"] = None
              st["last_alert_ts"] = None
              st["rebooted"] = False

          else:
              if st.get("down_since") is None:
                  st["down_since"] = now
                  st["last_alert_ts"] = now
                  st["rebooted"] = False
                  tg_send(f"‚ùå DOWN: {SITE_URL} ({info}) (0 –º–∏–Ω)")
              else:
                  down_min = minutes_since(st["down_since"])

                  # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø–æ —Ç–∞–π–º–µ—Ä—É (300 —Å–µ–∫)
                  last_alert_ts = int(st.get("last_alert_ts") or st["down_since"])
                  if now - last_alert_ts >= 300:
                      st["last_alert_ts"] = now
                      tg_send(f"‚ùå STILL DOWN: {SITE_URL} ({info}) (~{down_min} –º–∏–Ω)")

                  # reboot –ø–æ—Å–ª–µ 20 –º–∏–Ω—É—Ç DOWN (–æ–¥–∏–Ω —Ä–∞–∑)
                  if (not st.get("rebooted")) and down_min >= 20:
                      if hetzner_reboot():
                          st["rebooted"] = True
                          tg_send(f"üö® REBOOT triggered: {SITE_URL} DOWN ~{down_min} –º–∏–Ω (Hetzner)")
                      else:
                          tg_send(f"‚ö†Ô∏è REBOOT FAILED: {SITE_URL} DOWN ~{down_min} –º–∏–Ω (—Å–º. logs)")

          with open("state.json", "w", encoding="utf-8") as f:
              json.dump(st, f, ensure_ascii=False, indent=2)
          PY

      - name: Commit state
        run: |
          git config user.name "mite-watchdog"
          git config user.email "actions@users.noreply.github.com"
          git add state.json
          git commit -m "Update watchdog state" || echo "No changes"
          git push
